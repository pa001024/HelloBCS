function refreshStoreFiles(){return B.getDirAsync(ROOT_DIR).then(function(e){var r=[],n=[];return e.forEach(function(e){var t=e.server_filename;if(e.isdir&&!t.match(/^(?:#|!|XX)/)){var a=[];n.push(B.getDirAsync(e.path).then(function(n){n.forEach(function(e){e.server_filename.startsWith("[")&&a.push({fs_id:e.fs_id,path:e.path,name:e.server_filename})});var o=t.replace(/✓\d+?$/g,"✓"+a.length);o!=t&&(console.log("rename",e.path,"to",o),r.push({path:e.path,newname:o})),storeFile[o]=a}))}}),Promise.all(n).then(function(){return B.renameFileBatchAsync(r)})})}function refreshShareFiles(){return B.getShareRecordAsync().then(function(e){e.forEach(function(e){1==e.fsIds.length&&(shared_list[e.fsIds[0]]=1,e.status?(1==e.status&&B.cancelShareAsync([e.shareId]),8==e.status&&console.log(e.typicalPath+" 已被和谐 请用MD5补档")):shareFile[e.fsIds[0]]=e)});var r=[];for(var n in storeFile)storeFile[n].forEach(function(e){shareFile[e.fs_id+""]&&(e.shared=shareFile[e.fs_id+""])});return Promise.all(r)})}function getAvaliableList(){var e=[],r={};for(var n in storeFile)storeFile[n].forEach(function(n){var t=n.fs_id+"";shared_list[t]||(e.push(t),r[t]=n.path)});return[e,r]}function getRandomList(){var e=getAvaliableList(),r=e[0],n=e[1];return function(){var e=~~(Math.random()*r.length);r[0]=r[e]+(r[e]=r[0],"");var t=r.shift();return[t,n[t]]}}function getDirectLink(e){var r=e||getRandomList()()[1];B.getMetaAsync(r).then(function(e){console.log(r,e.dlink)})}function randomCreateShareAsync(){var e=Promise.defer(),r=getRandomList();return function n(){var t=r(),a=t[0],o=t[1];B.createShareByIdAsync(a).then(function(r){return 110==r.errno?void e.resolve():(console.log("create share",o,r),void n())})}(),e.promise}function sleep(e){var r=Promise.defer();return setTimeout(function(){r.resolve()},e),r.promise}function toMarkdown(e){var r="",n=0,t=0,a=[];for(var o in e)a.push(o);a=a.sort();for(var o=0;o<a.length;o++){var s=a[o],i=e[s];r+="## "+a[o]+"\n\n";for(var h=0;h<i.length;h++)r+=i[h].shared?"+ ["+i[h].name+"]("+i[h].shared.shortlink+")\n":"+ "+i[h].name+"\n",s.startsWith("8")?t++:n++;r+="\n"}return r+="共 "+n+" 部电影 "+t+" 部电视剧/番剧"}function downloadRAW(e,r){var n=new Blob([e]),t=URL.createObjectURL(n),a=document.createElement("a"),o=document.createEvent("MouseEvent");a.href=t,a.download=r,o.initEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(o)}var storeFile={},shareFile={},shared_list={},ROOT_DIR="/!电影分类版✓983";refreshStoreFiles().then(function(){return refreshShareFiles()}).then(function(){var e=toMarkdown(storeFile);downloadRAW(e,"all.md")});