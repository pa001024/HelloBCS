var B={getMetaAsync:function(e){var r="/api/filemetas?blocks=1&dlink=1",n=Promise.defer();return $.post(r,{target:JSON.stringify([e])},function(e){e.errno?n.reject(e):n.resolve(e.info[0])}),n.promise},getShareRecordAsync:function(){var e="/share/record?order=ctime&desc=1&page=",r=[],n=Promise.defer();return function i(t){$.getJSON(e+t,function(e){r=r.concat(e.list),e.nextpage?i(++t):n.resolve(r)})}(1),n.promise},getDirAsync:function(e){var r=Promise.defer(),n=[];return function i(t){$.getJSON("/api/list?&num=200&page="+t+"&order=name&showempty=0&dir="+encodeURI(e),function(e){n=n.concat(e.list),200==e.list.legnth?i(++t):r.resolve(n)})}(1),r.promise},createDirAsync:function(e){var r="/api/create?a=commit",n=Promise.defer();return $.post(r,{path:"/"+e,isdir:1,size:"",block_list:"[]",method:"post"},function(e){e.errno?n.reject(e):n.resolve(e)}),n.promise},createShareAsync:function(e,r){var n="/share/set",i=Promise.defer();if(r&&4!=encodeURIComponent(r).replace(/%../g,".").length)throw new Error(r+"is not a valid password!");return this.getMetaAsync(e).then(function(e){$.post(n,{fid_list:JSON.stringify([e.fs_id]),schannel:4,channel_list:"[]",pwd:r||"1111"},function(e){i.resolve(e)})}),i.promise},createShareByIdAsync:function(e,r){var n="/share/set",i=Promise.defer();if(r&&4!=encodeURIComponent(r).replace(/%../g,".").length)throw new Error(r+"is not a valid password!");return $.post(n,{fid_list:JSON.stringify([e]),schannel:4,channel_list:"[]",pwd:r||"1111"},function(e){i.resolve(e)}),i.promise},cancelShareAsync:function(e){var r="/share/cancel",n=Promise.defer();return $.post(r,{shareid_list:JSON.stringify(e)},function(e){n.resolve(e)}),n.promise},transferFileAsync:function(e,r,n,i){var t="/share/transfer",s=Promise.defer();return $.post(t+"?shareid="+e+"&from="+r,{filelist:JSON.stringify(["/"+n]),path:i},function(e){s.resolve(e)}),s.promise},renameFileAsync:function(e,r){return this.renameFileBatchAsync([{path:e,newname:r}])},renameFileBatchAsync:function(e){var r=Promise.defer();return $.post("/api/filemanager?opera=rename&async=2",{filelist:JSON.stringify(e)},function(n){$.post("/share/taskquery?&taskid="+n.taskid,{filelist:JSON.stringify(e)},function(e){r.resolve(e)})}),r.promise},copyFileAsync:function(e,r,n){return this.copyFileBatchAsync([{path:e,dest:r,newname:n}])},copyFileBatchAsync:function(e){var r=Promise.defer();return $.post("/api/filemanager?opera=copy&async=2",{filelist:JSON.stringify(e)},function(n){$.post("/share/taskquery?&taskid="+n.taskid,{filelist:JSON.stringify(e)},function(e){r.resolve(e)})}),r.promise},moveFileAsync:function(e,r,n){return this.moveFileBatchAsync([{path:e,dest:r,newname:n}])},moveFileBatchAsync:function(e){var r=Promise.defer();return $.post("/api/filemanager?opera=move&async=2",{filelist:JSON.stringify(e)},function(n){$.post("/share/taskquery?&taskid="+n.taskid,{filelist:JSON.stringify(e)},function(e){r.resolve(e)})}),r.promise},deleteFileAsync:function(e){return this.deleteFileBatchAsync([e])},deleteFileBatchAsync:function(e){var r=Promise.defer();return $.post("/api/filemanager?opera=delete&async=2",{filelist:JSON.stringify(e)},function(n){$.post("/share/taskquery?&taskid="+n.taskid,{filelist:JSON.stringify(e)},function(e){r.resolve(e)})}),r.promise}};
function refreshStoreFiles(){return B.getDirAsync(ROOT_DIR).then(function(e){var r=[],n=[];return e.forEach(function(e){var t=e.server_filename;if(e.isdir&&!t.match(/^(?:#|!|XX)/)){var a=[];n.push(B.getDirAsync(e.path).then(function(n){n.forEach(function(e){e.server_filename.startsWith("[")&&a.push({fs_id:e.fs_id,path:e.path,name:e.server_filename})});var o=t.replace(/✓\d+?$/g,"✓"+a.length);o!=t&&(console.log("rename",e.path,"to",o),r.push({path:e.path,newname:o})),storeFile[o]=a}))}}),Promise.all(n).then(function(){return B.renameFileBatchAsync(r)})})}function refreshShareFiles(){return B.getShareRecordAsync().then(function(e){e.forEach(function(e){1==e.fsIds.length&&(shared_list[e.fsIds[0]]=1,e.status?(1==e.status&&B.cancelShareAsync([e.shareId]),8==e.status&&console.log(e.typicalPath+" 已被和谐 请用MD5补档")):shareFile[e.fsIds[0]]=e)});var r=[];for(var n in storeFile)storeFile[n].forEach(function(e){shareFile[e.fs_id+""]&&(e.shared=shareFile[e.fs_id+""])});return Promise.all(r)})}function getAvaliableList(){var e=[],r={};for(var n in storeFile)storeFile[n].forEach(function(n){var t=n.fs_id+"";shared_list[t]||(e.push(t),r[t]=n.path)});return[e,r]}function getRandomList(){var e=getAvaliableList(),r=e[0],n=e[1];return function(){var e=~~(Math.random()*r.length);r[0]=r[e]+(r[e]=r[0],"");var t=r.shift();return[t,n[t]]}}function getDirectLink(e){var r=e||getRandomList()()[1];B.getMetaAsync(r).then(function(e){console.log(r,e.dlink)})}function randomCreateShareAsync(){var e=Promise.defer(),r=getRandomList();return function n(){var t=r(),a=t[0],o=t[1];B.createShareByIdAsync(a).then(function(r){return 110==r.errno?void e.resolve():(console.log("create share",o,r),void n())})}(),e.promise}function sleep(e){var r=Promise.defer();return setTimeout(function(){r.resolve()},e),r.promise}function toMarkdown(e){var r="",n=0,t=0,a=[];for(var o in e)a.push(o);a=a.sort();for(var o=0;o<a.length;o++){var s=a[o],i=e[s];r+="## "+a[o]+"\n\n";for(var h=0;h<i.length;h++)r+=i[h].shared?"+ ["+i[h].name+"]("+i[h].shared.shortlink+")\n":"+ "+i[h].name+"\n",s.startsWith("8")?t++:n++;r+="\n"}return r+="共 "+n+" 部电影 "+t+" 部电视剧/番剧"}function downloadRAW(e,r){var n=new Blob([e]),t=URL.createObjectURL(n),a=document.createElement("a"),o=document.createEvent("MouseEvent");a.href=t,a.download=r,o.initEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(o)}var storeFile={},shareFile={},shared_list={},ROOT_DIR="/!电影分类版✓983";refreshStoreFiles().then(function(){return refreshShareFiles()}).then(function(){var e=toMarkdown(storeFile);downloadRAW(e,"all.md")});