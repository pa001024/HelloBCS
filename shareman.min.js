// 百度网页版分享管理(with lib v1.0.0) v1.0.1 (minify)
function refreshStoreFiles(){return storeFile=[],B.getDirAsync(ROOT_DIR).then(function(a){var b=[],c=[];return a.forEach(function(a){var d=a.server_filename;if(a.isdir&&!d.match(/^(?:#|!|XX)/)){var e=[];c.push(B.getDirAsync(a.path).then(function(c){c.forEach(function(a){a.server_filename.startsWith("[")&&e.push({fs_id:a.fs_id,path:a.path,name:a.server_filename})});var f=d.replace(/\u2713\d+?$/g,"\u2713"+e.length);f!=d&&(console.log("rename",a.path,"to",f),b.push({path:a.path,newname:f})),storeFile[f]=e}))}}),Promise.all(c).then(function(){return B.renameFileBatchAsync(b)})})}function refreshShareFiles(){return shared_list=[],B.getShareRecordAsync().then(function(a){baned_list=[],a.forEach(function(a){1==a.fsIds.length&&(shared_list[a.fsIds[0]]=1,a.status?(1==a.status||8==a.status)&&baned_list.push(a.typicalPath):shareFile[a.fsIds[0]]=a)});var b=[];for(var c in storeFile)storeFile[c].forEach(function(a){shareFile[a.fs_id+""]&&(a.shared=shareFile[a.fs_id+""])});return console.log(baned_list.length+" \u4e2a\u8d44\u6e90\u5df2\u88ab\u548c\u8c10 \u8bf7\u6362MD5\u8865\u6863 \u8f93\u5165baned_list\u67e5\u770b\u8be6\u60c5"),Promise.all(b)})}function getAvaliableList(){var a=[],b={};for(var c in storeFile)storeFile[c].forEach(function(c){var d=c.fs_id+"";shared_list[d]||(a.push(d),b[d]=c.path)});return[a,b]}function getRandomList(){var a=getAvaliableList(),b=a[0],c=a[1];return function(){var a=~~(Math.random()*b.length);b[0]=b[a]+(b[a]=b[0],"");var d=b.shift();return[d,c[d]]}}function getDirectLink(a){var b=a||getRandomList()()[1];B.getMetaAsync(b).then(function(a){console.log(b,a.dlink)})}function randomCreateShareAsync(){var a=Promise.defer(),b=getRandomList();return console.log("[\u81ea\u52a8\u5206\u4eab] \u5c1d\u8bd5\u521b\u5efa\u5206\u4eab\u4e2d"),function c(){var d=b(),e=d[0],f=d[1];B.createShareByIdAsync(e).then(function(b){110!=b.errno&&($.get(b.shorturl,function(){a.resolve()}),console.log("create share",f),c())})}(),a.promise.then(function(){console.log("[\u540e\u53f0] \u53ef\u8f93\u5165\u4ee5\u4e0b\u6307\u4ee4:\n\u83b7\u53d6\u5217\u8868 refreshStoreFiles().then(refreshShareFiles).then(outputMarkdown)\n\u521b\u5efa\u5206\u4eab randomCreateShareAsync()")})}function createrandomCreateTask(){return console.log("[\u81ea\u52a8\u5206\u4eab] \u81ea\u52a8\u5206\u4eab\u5f00\u59cb \u7ed3\u675f\u8f93\u5165 clearInterval(createrandomCreateTask.vv)\n\u5feb\u901f\u5f00\u59cb\u7b2c\u4e00\u6b21\u5206\u4eab\u8f93\u5165 randomCreateShareAsync().then(refreshShareFiles)"),createrandomCreateTask.vv=setInterval(function(){randomCreateShareAsync().then(refreshShareFiles)},9e5)}function sleep(a){var b=Promise.defer();return setTimeout(function(){b.resolve()},a),b.promise}function toMarkdown(a,b){var c="",d=0,e=0,f=0,g=[];for(var h in a)g.push(h);g=g.sort();for(var h=0;h<g.length;h++){var i=g[h],j=a[i];c+="## "+g[h]+"\n\n";for(var k=0;k<j.length;k++)j[k].shared?(c+="+ ["+j[k].name+"]("+j[k].shared.shortlink+")\n",f++):c+="+ "+j[k].name+"\n",i.startsWith("8")?e++:d++;c+="\n"}c+="\u5171 "+d+" \u90e8\u7535\u5f71 "+e+" \u90e8\u7535\u89c6\u5267/\u756a\u5267 "+f+" \u5df2\u94fe\u63a5";var l=function(a){return"\u622a\u81f3"+a.getFullYear()+"\u5e74"+(a.getMonth()+1)+"\u6708"+a.getDate()+"\u65e5"}(new Date);return c=">\uff08"+l+" \u5171 "+d+" \u90e8\u7535\u5f71 "+e+" \u90e8\u7535\u89c6\u5267/\u756a\u5267 "+f+" \u90e8\u5df2\u94fe\u63a5\uff09\n\n"+c,c="#### [__>>>\u70b9\u6b64\u52a0\u5165\u767e\u5ea6\u4e91\u7fa4\u7ec4<<<__]("+b+")\n\n"+c}function downloadRAW(a,b){var c=new Blob([a]),d=URL.createObjectURL(c),e=document.createElement("a"),f=document.createEvent("MouseEvent");e.href=d,e.download=b,e.rel="noreferrer",f.initEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),e.dispatchEvent(f)}function outputMarkdown(){B.createGroupInvite("2031654130988868652").then(function(a){console.log(a);var b=toMarkdown(storeFile,a);downloadRAW(b,"all.md")})}var B={createGroupInvite:function(a){var b="/mbox/group/invite?gid=",c=Promise.defer();return $.get(b+a,function(a){a.errno?c.reject(a):c.resolve(a.link)}),c.promise},getMetaAsync:function(a){var b="/api/filemetas?blocks=1&dlink=1",c=Promise.defer();return $.post(b,{target:JSON.stringify([a])},function(a){a.errno?c.reject(a):c.resolve(a.info[0])}),c.promise},getShareRecordAsync:function(){var a="/share/record?order=ctime&desc=1&page=",b=[],c=Promise.defer();return function d(e){$.getJSON(a+e,function(a){b=b.concat(a.list),a.nextpage?d(++e):c.resolve(b)})}(1),c.promise},getDirAsync:function(a){var b=Promise.defer(),c=[];return function d(e){$.getJSON("/api/list?&num=200&page="+e+"&order=name&showempty=0&dir="+encodeURI(a),function(a){c=c.concat(a.list),200==a.list.legnth?d(++e):b.resolve(c)})}(1),b.promise},createDirAsync:function(a){var b="/api/create?a=commit",c=Promise.defer();return $.post(b,{path:"/"+a,isdir:1,size:"",block_list:"[]",method:"post"},function(a){a.errno?c.reject(a):c.resolve(a)}),c.promise},createShareAsync:function(a,b){var c="/share/set",d=Promise.defer();if(b&&4!=encodeURIComponent(b).replace(/%../g,".").length)throw new Error(b+"is not a valid password!");return this.getMetaAsync(a).then(function(a){$.post(c,{fid_list:JSON.stringify([a.fs_id]),schannel:4,channel_list:"[]",pwd:b||"1111"},function(a){d.resolve(a)})}),d.promise},createShareByIdAsync:function(a,b){var c="/share/set",d=Promise.defer();if(b&&4!=encodeURIComponent(b).replace(/%../g,".").length)throw new Error(b+"is not a valid password!");return $.post(c,{fid_list:JSON.stringify([a]),schannel:4,channel_list:"[]",pwd:b||"1111"},function(a){d.resolve(a)}),d.promise},cancelShareAsync:function(a){var b="/share/cancel",c=Promise.defer();return $.post(b,{shareid_list:JSON.stringify(a)},function(a){c.resolve(a)}),c.promise},transferFileAsync:function(a,b,c,d){var e="/share/transfer",f=Promise.defer();return $.post(e+"?shareid="+a+"&from="+b,{filelist:JSON.stringify(["/"+c]),path:d},function(a){f.resolve(a)}),f.promise},renameFileAsync:function(a,b){return this.renameFileBatchAsync([{path:a,newname:b}])},renameFileBatchAsync:function(a){var b=Promise.defer();return $.post("/api/filemanager?opera=rename&async=2",{filelist:JSON.stringify(a)},function(c){$.post("/share/taskquery?&taskid="+c.taskid,{filelist:JSON.stringify(a)},function(a){b.resolve(a)})}),b.promise},copyFileAsync:function(a,b,c){return this.copyFileBatchAsync([{path:a,dest:b,newname:c}])},copyFileBatchAsync:function(a){var b=Promise.defer();return $.post("/api/filemanager?opera=copy&async=2",{filelist:JSON.stringify(a)},function(c){$.post("/share/taskquery?&taskid="+c.taskid,{filelist:JSON.stringify(a)},function(a){b.resolve(a)})}),b.promise},moveFileAsync:function(a,b,c){return this.moveFileBatchAsync([{path:a,dest:b,newname:c}])},moveFileBatchAsync:function(a){var b=Promise.defer();return $.post("/api/filemanager?opera=move&async=2",{filelist:JSON.stringify(a)},function(c){$.post("/share/taskquery?&taskid="+c.taskid,{filelist:JSON.stringify(a)},function(a){b.resolve(a)})}),b.promise},deleteFileAsync:function(a){return this.deleteFileBatchAsync([a])},deleteFileBatchAsync:function(a){var b=Promise.defer();return $.post("/api/filemanager?opera=delete&async=2",{filelist:JSON.stringify(a)},function(c){$.post("/share/taskquery?&taskid="+c.taskid,{filelist:JSON.stringify(a)},function(a){b.resolve(a)})}),b.promise}},storeFile={},shareFile={},shared_list={},baned_list=[],ROOT_DIR="/!\u7535\u5f71\u5206\u7c7b\u7248\u27131022";refreshStoreFiles().then(refreshShareFiles).then(outputMarkdown).then(createrandomCreateTask);